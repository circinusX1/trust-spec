
#ifndef CPLUSPLUS
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/kmod.h>
#include <linux/kthread.h>
#include <linux/miscdevice.h>
#include <linux/mnt_idmapping.h>
#include <linux/fs_struct.h>
#include <net/sock.h>
#include <linux/sched.h>
#include <linux/pid.h>

///////////////////////////////////////////////////////////////////////////////////////////////////
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Marius Chincisan");
MODULE_DESCRIPTION("A kernel module to secure patts of rootfa");
MODULE_VERSION("0.2");

///////////////////////////////////////////////////////////////////////////////////////////////////
#define MAX_ARGS            16
#define SANE_DEVICE_PBK     "sane-mco"                          // /dev/****
#define PUBLIC_KEY          "/dev/sane-mco"                     //
#define TMP_BASH            "/tmp/sane-run"                     // tmp bash file kernel runs
#define SANE_PROG           "/usr/bin/sanesystem"               // user space program, on RO partition usually
#define SANE_PROG_CFG       "/usr/bin/sanesystem.conf"          // configuration file
#define PRIVATE_KEY         "/data/sane/sane-priv.TMP"          // private key will be deleted after first run
#define SANE_PROG_SIG       "/data/sane/sane-system.SIG"        // signature for sanesystem
#define SANE_PROG_CFG_SIG   "/data/sane/sane-system.conf.SIG"   // signature for sanesystem.conf
#define SYSTEM_CRC_DIR      "/data/sane/"
#define OPEN_SSL            "/usr/bin/openssl"

///////////////////////////////////////////////////////////////////////////////////////////////////
static const char DEV_CONTENT[]
    = "-----BEGIN PUBLIC KEY-----\n"
      "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvAFFFqe+OX6FePPNQbh+\n"
      "du2HNXsszJh+AWWCuV8ysotZMU/OD+ENmCnwjadMejtPq5jxxdji2pOCWEVCqcGk\n"
      "8qA7M5ehLy88kFERI7BW+rLiC9b26Np/n1z9Yg4yVs4SXVENg5t3RzMQOGJPR39q\n"
      "cfrj/LkPwYUzsyPlnXrp3MJ3F97X96Z5UI8U0+mJUGiaiPnL+vYqun0IL3Fp24iA\n"
      "sFHny+cw3+favXezhVI65cUnEBbBPaxg62jvRs4odrrGMQyKAljdjs2sKpvywj4R\n"
      "6nbvcUnupczbbkurkLNIXOGa+fgNXdDtVegSa5sJXOBf2jPVsOEkDhJ8Swq7cHQ5\n"
      "fQIDAQAB\n"
      "-----END PUBLIC KEY-----\n";

#define UDP_PORT    15390
#define BUF_SIZE    4096
#define MAX_ARGS    16
static char *envp[] = {"HOME=/root", "PATH=/sbin:/bin:/usr/sbin:/usr/bin", "TERM=linux", NULL};
static struct task_struct *main_thr = NULL;
static struct task_struct *udp_thr = NULL;
static char SYSTEM_CRC_FILE[256] = {0};

/**
 * @brief kill_system
 */
static void kill_system(void)
{
    struct task_struct *task;

    printk(KERN_INFO "=== Enumerating all tasks ===\n");
    printk(KERN_INFO "%-8s %-20s %s\n", "PID", "COMM", "STATE");
/*
    for_each_process(task)
    {
        pr_info( "%-8d %-20s %ld\n",
               task_pid_nr(task),
               task->comm,
               task->stats);
    }
*/

}

/**
 * @brief delete_file
 * @param path
 * @return
 */
static int delete_file(char *path)
{
    char *argv[] = {"/bin/unlink", path, NULL};
    return call_usermodehelper(argv[0], argv, envp, UMH_WAIT_PROC);
}

/**
 * @brief is_file
 * @param path
 * @return
 */
static int is_file(const char *path)
{
    struct file *filp;
    loff_t pos = 0;
    ssize_t read = 0;
    int i;
    char   some[sizeof(size_t)];

    for(i=0;i<10;i++)
    {
        msleep(200);
        filp = filp_open(path, O_RDONLY, 0);
        if (IS_ERR(filp))
        {
            continue;
        }
        read = kernel_read(filp, some, sizeof(some), &pos);
        filp_close(filp, NULL);
        if (read > 0 )
        {
            pr_info("is_file: %s", path);
            break;
        }
    }
    if(read<=0)
    {
        pr_err("No file: %s", path);
    }
    return read > 0 ? 0 : 2;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
static int write_file_buff(const char *filename, const char *content)
{
    struct file *file = NULL;
    loff_t pos = 0;
    ssize_t written;
    size_t len = strlen(content);
    int rv = 0;

    file = filp_open(filename, O_CREAT | O_RDWR, 0777);

    if (IS_ERR(file))
    {
        pr_err("open %s. Error: %ld\n", filename, PTR_ERR(file));
        return -EIO;
    }
    msleep(10);
    written += kernel_write(file, content, len, &pos);
    msleep(10);
    if (written != (len))
    {
        rv = -2;
        pr_err("wrote %d of %d bytes.\n", (int)written, (int)len);
    }
    filp_close(file, NULL);
    pr_info("File: %s <- %s", filename, content);
    return rv;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static ssize_t read_file_buff(char *file, char *local, int size)
{
    ssize_t read = 0;
    loff_t pos = 0;

    struct file *filp = filp_open(file, O_RDONLY, 0);

    if (IS_ERR(filp))
    {
        pr_err("Cannot open file: %s\n", file);
        return 0;
    }
    read = kernel_read(filp, local, size, &pos);
    filp_close(filp, NULL);
    if (read < 0)
    {
        pr_err("kernel_read() error: %d\n", (int)read);
    }
    return read;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static int kexec_proc(const char *path, ...)
{
    va_list ap;
    char *argv[MAX_ARGS];
    int i = 0;
    char *p;
    char trace[256] = {0};

    va_start(ap, path);
    argv[i++] = (char *) path;
    strcat(trace, path);
    strcat(trace, " ");

    while (i < (MAX_ARGS - 1)) {
        p = va_arg(ap, char *);
        if (!p)
            break;
        argv[i++] = p;
        strcat(trace, p);
        strcat(trace, " ");
    }
    argv[i] = NULL;
    va_end(ap);

    int rve = call_usermodehelper(argv[0], argv, envp, UMH_WAIT_PROC);
    pr_info("%s -> %d\n", trace, rve);
    return rve;
}

static int kexec_proc2(const char *path, ...)
{
    va_list ap;
    int i = 0;
    char *p;
    char trace[256] = {0};

    msleep(512);
    va_start(ap, path);
    strcat(trace, "#!/bin/bash\n");
    strcat(trace, path);
    strcat(trace, " ");

    while (i < (MAX_ARGS - 1)) {
        p = va_arg(ap, char *);
        if (!p)
            break;
        strcat(trace, p);
        strcat(trace, " ");
    }
    va_end(ap);
    strcat(trace, "\n");
    write_file_buff(TMP_BASH, trace);
    return kexec_proc("/bin/bash", TMP_BASH, NULL);
}

////////////////////////////////////////////////////////////////////////////////
static int check_key(void)
{
    int rv = kexec_proc2("/usr/bin/openssl ",
                         " rsa -in ",
                         PRIVATE_KEY,
                         "-outform PEM -pubout -out "
                         "/tmp/sane-pub-key",
                         NULL);
    char loco[512] = {0};
    ssize_t len = read_file_buff("/tmp/sane-pub-key", loco, sizeof(loco));
    if (len != strlen(DEV_CONTENT)) {
        pr_err("public key length %d != %d", (int)len, (int)strlen(DEV_CONTENT));
        kill_system();
        return len;
    } else {
        if (memcmp(loco, DEV_CONTENT,sizeof(DEV_CONTENT)) == 0)
        {
            pr_info("%s",loco);
            pr_info("private key verified\n");
            rv = 0;
        }
        else
        {
            pr_err("public key content failed\n");
            kill_system();
        }
    }
    return rv;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static int first_time(void)
{
    int is1,is2;

    pr_info("FIRST TIME %s FOUND..............................................\n", PRIVATE_KEY);
    if (check_key() != 0)
    {
        pr_err("<------ check_key %s ERR", PRIVATE_KEY);
        kill_system();
        return 1;
    }
    if(is_file(SANE_PROG)==0 && is_file(SANE_PROG_CFG)==0)
    {
        pr_info("----> %s FOUND\n", SANE_PROG);
        is_file(PRIVATE_KEY);
        kexec_proc2(OPEN_SSL, "dgst -sha256 -sign",PRIVATE_KEY,"-out",SANE_PROG_SIG,SANE_PROG, NULL);
        is1=is_file(SANE_PROG_SIG);

        is_file(PRIVATE_KEY);
        kexec_proc2(OPEN_SSL, "dgst -sha256 -sign",PRIVATE_KEY,"-out",SANE_PROG_CFG_SIG,SANE_PROG_CFG,NULL);
        is2=is_file(SANE_PROG_CFG_SIG);

        if(is1 != 0 || is2 != 0)
        {
            pr_err("<---- Err cannot find %s or %s\n", SANE_PROG_SIG, SANE_PROG_CFG_SIG);
            kill_system();
            return 2;
        }
        else
        {
            pr_info("Successfully signed: %s %s", SANE_PROG_SIG, SANE_PROG_CFG_SIG);
        }
    }
    else
    {
        pr_err("<---- Err find %s<.cfg>\n", SANE_PROG);
        kill_system();
        return 3;
    }
    return 0;
}
///////////////////////////////////////////////////////////////////////////////////////////////////
static int udp_foo(void *data)
{
    struct socket *sock;
    struct sockaddr_in addr;
    int ret;
    char buf[512];

    // Create UDP socket
    ret = sock_create(AF_INET, SOCK_DGRAM, IPPROTO_UDP, &sock);
    if (ret < 0) {
        pr_err("udpmod:     Failed to create socket: %d, exit thread", ret);
        return -1;
    }

    memset(&addr, 0, sizeof(addr));
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = htonl(INADDR_ANY);
    addr.sin_port = htons(UDP_PORT);

    int val = 1;
    sockptr_t optval = KERNEL_SOCKPTR(&val);
    sock->ops->setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, optval, sizeof(int));
    sock->ops->setsockopt(sock, SOL_SOCKET, SO_REUSEPORT, optval, sizeof(int));
    sock->ops->setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, optval, sizeof(int));
    sock->ops->setsockopt(sock, SOL_SOCKET, SO_REUSEPORT, optval, sizeof(int));

    ret = sock->ops->bind(sock, (struct sockaddr *)&addr, sizeof(addr));
    if (ret < 0) {
        pr_err("udpmod:     Failed to bind socket: %d\n", ret);
        sock_release(sock);
        return -1;
    }

    pr_info("udpmod:    Listening on UDP port UDP_PORT\n");

    while (!kthread_should_stop())
    {
        struct msghdr msg = { };
        struct kvec vec;
        int len;

        vec.iov_base = buf;
        vec.iov_len = sizeof(buf)-1;

        len = kernel_recvmsg(sock, &msg, &vec, 1, sizeof(buf)-1, MSG_DONTWAIT);

        if (len > 0)
        {
            buf[len] = '\0';
            pr_warn("udpmod: <----[ %s ]<-----\n", buf);
        }
        if(strstr(buf,"error"))
        {
            kill_system();
        }
        msleep(100);
    }

    sock_release(sock);
    pr_info("udpmod:  thread exiting\n");
    return 0;

}

///////////////////////////////////////////////////////////////////////////////////////////////////
static int main_foo(void *data)
{
    int rv = 0;
    bool ft = false;
    char crc_sig[266];
    int is1, is2;
    int fivemin=0;

    if (is_file(PRIVATE_KEY) == 0)
    {
        rv = first_time();
        ft = true;
    }
    if(rv == 0)
    {
        //check the sigs
        pr_info(">>Checking %s->%s", SANE_PROG,SANE_PROG_SIG);

        kexec_proc2(OPEN_SSL, "dgst -sha256 -verify", PUBLIC_KEY, "-signature", SANE_PROG_SIG, SANE_PROG," > /tmp/sane-sig" ,NULL);
        is1 = is_file("/tmp/sane-sig");
        kexec_proc2(OPEN_SSL, "dgst -sha256 -verify", PUBLIC_KEY, "-signature", SANE_PROG_CFG_SIG, SANE_PROG_CFG," > /tmp/sane-cfg-sig" ,NULL);
        is2 = is_file("/tmp/sane-cfg-sig");

        if(is1==0 && is2==0 )
        {
            pr_info(">>Programs to check has not been alterred");
            if(ft)
            {
                pr_info(">>Taking snapshot");
                sprintf(crc_sig,"%s.SIG",SYSTEM_CRC_FILE);
                kexec_proc2(SANE_PROG,"CREATE", SYSTEM_CRC_FILE, PRIVATE_KEY, NULL);
                if(is_file(crc_sig)!=0)
                {
                    pr_err("<<Failed to do: %s",crc_sig);
                    pr_info("<<<<<<< threaddone");
                    kill_system();
                    return 0;
                }

                pr_info(">>%s and %s secured", SYSTEM_CRC_FILE, crc_sig);
                delete_file(PRIVATE_KEY);
            }
            while (!kthread_should_stop())
            {
                pr_info(">>Checking against %s", SYSTEM_CRC_FILE);
                kexec_proc2(SANE_PROG,"VERIFY",SYSTEM_CRC_FILE,PUBLIC_KEY,NULL);
                for(fivemin=0;fivemin < 30; fivemin++)
                {
                    if(kthread_should_stop())
                    {
                        break;
                    }
                    msleep(1000);
                }
            }
        }
        else
        {
            pr_err("Verification for %s and %s failed",SANE_PROG_CFG, SANE_PROG_CFG_SIG);
            kill_system();
        }
    }
    pr_info("<<<<<<< threaddone");
    return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static ssize_t sanedev_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
{
    size_t len = strlen(DEV_CONTENT);
    size_t remaining;

    if (*ppos >= len)
        return 0;

    remaining = len - *ppos;
    if (count < remaining)
        len = count;
    else
        len = remaining;

    if (copy_to_user(buf, DEV_CONTENT + *ppos, len))
        return -EFAULT;

    *ppos += len;
    return len;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static const struct file_operations sanedev_fops =
    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .owner = THIS_MODULE,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .read = sanedev_read,
};

///////////////////////////////////////////////////////////////////////////////////////////////////
static struct miscdevice sanedev_misc =
    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .minor = MISC_DYNAMIC_MINOR, /* let kernel assign minor number */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .name = SANE_DEVICE_PBK,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .fops = &sanedev_fops,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               .mode = 0444 /* read-only for everyone */
};

///////////////////////////////////////////////////////////////////////////////////////////////////
static int __init sane_init(void)
{
    int ret;
    ret = misc_register(&sanedev_misc);
    if (ret) {
        pr_err("sanedev: cannot register misc device\n");
        return ret;
    }

    dev_t root_dev = current->fs->root.mnt->mnt_sb->s_dev;
    sprintf(SYSTEM_CRC_FILE, "%s/%s-%d.%d.CRC",SYSTEM_CRC_DIR, "sane-system-crc", MAJOR(root_dev), MINOR(root_dev));
    pr_info(">>>  CRCFILE: %s", SYSTEM_CRC_FILE);

    udp_thr = kthread_run(main_foo, NULL, "myt");
    if (IS_ERR(udp_thr)) {
        pr_err( "Failed to create thread\n");
        return PTR_ERR(udp_thr);
    }
    get_task_struct(udp_thr);
    wake_up_process(udp_thr);

    main_thr = kthread_run(udp_foo, NULL, "myt");
    if (IS_ERR(main_thr)) {
        pr_err( "Failed to create thread\n");
        return PTR_ERR(main_thr);
    }
    get_task_struct(main_thr);
    wake_up_process(main_thr);

    pr_info("/dev/%s created\n", SANE_DEVICE_PBK);
    return 0;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
static void __exit sane_exit(void)
{
    if (main_thr != 0) {
        kthread_stop(main_thr);
        put_task_struct(main_thr);
    }
    if (udp_thr != 0) {
        kthread_stop(udp_thr);
        put_task_struct(udp_thr);
    }
    misc_deregister(&sanedev_misc);
    pr_info("sane exits\n\n\n");
}

module_init(sane_init);
module_exit(sane_exit);

#endif



